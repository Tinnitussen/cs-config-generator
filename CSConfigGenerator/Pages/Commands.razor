@page "/commands"
@using CSConfigGenerator.Models
@using CSConfigGenerator.Interfaces
@using Microsoft.AspNetCore.Components.QuickGrid
@inject ISchemaService SchemaService

<PageTitle>Commands</PageTitle>

<header class="mb-3">
    <h1>Commands</h1>
    <p class="text-muted">Browse and search all @_allCommands.Count console commands and variables.</p>
</header>

<!-- Filters -->
<section aria-labelledby="filters-heading" class="mb-3">
    <h2 id="filters-heading" class="visually-hidden">Filters</h2>

    <!-- Search Row -->
    <div class="row g-2 align-items-end">
        <div class="col-md-6">
            <label for="search-input" class="form-label small text-muted mb-1">Search</label>
            <div class="input-group input-group-sm">
                <span class="input-group-text"><i class="bi bi-search" aria-hidden="true"></i></span>
                <input id="search-input"
                       type="text"
                       class="form-control"
                       placeholder="Command name or description..."
                       @bind="_searchTerm"
                       @bind:event="oninput"
                       @bind:after="ApplyFilters" />
                @if (!string.IsNullOrEmpty(_searchTerm))
                {
                    <button class="btn btn-outline-secondary" type="button" @onclick="ClearSearch" aria-label="Clear search">
                        <i class="bi bi-x" aria-hidden="true"></i>
                    </button>
                }
            </div>
        </div>
        <div class="col-md-6 text-end">
            @if (HasActiveFilters)
            {
                <button class="btn btn-sm btn-outline-secondary" @onclick="ClearAllFilters">
                    <i class="bi bi-x-circle me-1" aria-hidden="true"></i>Clear Filters
                </button>
            }
            <span class="ms-2 small text-muted">@FilteredCount results</span>
        </div>
    </div>
</section>

<!-- Commands Grid -->
<section aria-labelledby="commands-heading" class="commands-grid-container">
    <h2 id="commands-heading" class="visually-hidden">Command List</h2>

    <div class="quickgrid-wrapper">
        <QuickGrid @ref="_commandsGrid" Items="@FilteredCommands" Virtualize="true" ItemSize="40" Class="table table-sm table-hover table-bordered commands-table">
            <PropertyColumn Property="@(c => c.Command)" Title="Command" Class="col-command" />
            <PropertyColumn Property="@(c => c.TypeInfo.Type)" Title="Type" Class="col-type">
                <ColumnOptions>
                    <div class="column-options-panel">
                        @foreach (var type in _typeFilterOptions)
                        {
                            <label class="column-option-item">
                                <input type="checkbox"
                                       checked="@_selectedTypeFilters.Contains(type)"
                                       @onchange="@(e => ToggleTypeFilter(type, (bool)(e.Value ?? false)))" />
                                @type
                            </label>
                        }
                    </div>
                </ColumnOptions>
            </PropertyColumn>
            <TemplateColumn Title="Description" Class="col-description">
                @GetDescription(context)
            </TemplateColumn>
            <PropertyColumn Property="@(c => c.ConsoleData.DefaultValue)" Title="Default" Class="col-default" />
            <TemplateColumn Title="Flags" Class="col-flags">
                <ColumnOptions>
                    <div class="column-options-panel">
                        @foreach (var flag in _flagFilterOptions)
                        {
                            <label class="column-option-item">
                                <input type="checkbox"
                                       checked="@_selectedFlagFilters.Contains(flag)"
                                       @onchange="@(e => ToggleFlagFilter(flag, (bool)(e.Value ?? false)))" />
                                @flag
                            </label>
                        }
                    </div>
                </ColumnOptions>
                <ChildContent>
                    @if (context.ConsoleData.Flags?.Count > 0)
                    {
                        @foreach (var flag in context.ConsoleData.Flags)
                        {
                            <span class="badge @GetFlagBadgeClass(flag) me-1">@flag</span>
                        }
                    }
                    else
                    {
                        <span class="text-muted">—</span>
                    }
                </ChildContent>
            </TemplateColumn>
            <TemplateColumn Title="Sourced" Class="col-sourced">
                @if (context.ConsoleData.SourcedAt.HasValue)
                {
                    @context.ConsoleData.SourcedAt.Value.ToString("yyyy-MM-dd")
                }
                else
                {
                    <span class="text-muted">—</span>
                }
            </TemplateColumn>
        </QuickGrid>
    </div>
</section>

@code {
    private QuickGrid<CommandDefinition>? _commandsGrid;
    private List<CommandDefinition> _allCommands = [];
    private IQueryable<CommandDefinition> _filteredCommands = Enumerable.Empty<CommandDefinition>().AsQueryable();
    private string _searchTerm = string.Empty;

    // Type filter
    private List<string> _typeFilterOptions = [];
    private readonly HashSet<string> _selectedTypeFilters = [];

    // Flag filter
    private List<string> _flagFilterOptions = [];
    private readonly HashSet<string> _selectedFlagFilters = [];

    protected override void OnInitialized()
    {
        _allCommands = SchemaService.Commands.OrderBy(c => c.Command).ToList();
        DiscoverFilterOptions();
        ApplyFilters();
    }

    private void DiscoverFilterOptions()
    {
        // Get unique types
        _typeFilterOptions = _allCommands
            .Select(c => c.TypeInfo.Type.ToString())
            .Distinct()
            .OrderBy(t => t)
            .ToList();

        // Get unique flags
        _flagFilterOptions = _allCommands
            .SelectMany(c => c.ConsoleData.Flags ?? [])
            .Distinct()
            .OrderBy(f => f)
            .ToList();
    }

    private bool HasActiveFilters =>
        !string.IsNullOrEmpty(_searchTerm) ||
        _selectedTypeFilters.Count > 0 ||
        _selectedFlagFilters.Count > 0;

    private IQueryable<CommandDefinition> FilteredCommands => _filteredCommands;

    private int FilteredCount => _filteredCommands.Count();

    private void ToggleTypeFilter(string type, bool isSelected)
    {
        if (isSelected)
            _selectedTypeFilters.Add(type);
        else
            _selectedTypeFilters.Remove(type);
        ApplyFilters();
    }

    private void ToggleFlagFilter(string flag, bool isSelected)
    {
        if (isSelected)
            _selectedFlagFilters.Add(flag);
        else
            _selectedFlagFilters.Remove(flag);
        ApplyFilters();
    }

    private void ApplyFilters()
    {
        IEnumerable<CommandDefinition> query = _allCommands;

        // Search filter
        if (!string.IsNullOrWhiteSpace(_searchTerm))
        {
            var term = _searchTerm.Trim();
            query = query.Where(c =>
                c.Command.Contains(term, StringComparison.OrdinalIgnoreCase) ||
                c.DisplayDescription.Contains(term, StringComparison.OrdinalIgnoreCase));
        }

        // Type filter (OR within selection)
        if (_selectedTypeFilters.Count > 0)
        {
            query = query.Where(c => _selectedTypeFilters.Contains(c.TypeInfo.Type.ToString()));
        }

        // Flag filter (OR within selection)
        if (_selectedFlagFilters.Count > 0)
        {
            query = query.Where(c =>
                c.ConsoleData.Flags != null &&
                c.ConsoleData.Flags.Any(f => _selectedFlagFilters.Contains(f)));
        }

        _filteredCommands = query.ToList().AsQueryable();
    }

    private void ClearSearch()
    {
        _searchTerm = string.Empty;
        ApplyFilters();
    }

    private void ClearAllFilters()
    {
        _searchTerm = string.Empty;
        _selectedTypeFilters.Clear();
        _selectedFlagFilters.Clear();
        ApplyFilters();
    }

    private static string GetDescription(CommandDefinition command)
    {
        var text = command.DisplayDescription;
        if (string.IsNullOrEmpty(text)) return "—";
        return text.Length > 100 ? text[..97] + "..." : text;
    }

    private static string GetFlagBadgeClass(string flag) => flag switch
    {
        "cheat" => "bg-warning text-dark",
        "sv" => "bg-info text-dark",
        "cl" => "bg-secondary",
        "release" => "bg-success",
        "hidden" => "bg-dark",
        _ => "bg-light text-dark"
    };
}
