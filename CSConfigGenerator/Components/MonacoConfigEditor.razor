@using BlazorMonaco.Editor
@inject IJSRuntime JSRuntime

<div class="monaco-editor-wrapper">
    <StandaloneCodeEditor @ref="_editor" Id="config-editor" ConstructionOptions="EditorConstructionOptions" OnDidInit="EditorOnDidInit" />
</div>

<style>
    .monaco-editor-wrapper {
        height: 100%;
        width: 100%;
        min-height: 400px;
        border: 1px solid #ccc;
    }
</style>

@code {
    // NOTE: @ref is assigned before the underlying JS editor exists. We must not call any
    // BlazorMonaco JS interop until OnDidInit fires.
    private StandaloneCodeEditor? _editor;
    private bool _isEditorInitialized;
    private TextModel? _pendingModel;
    private string? _currentModelUri;
    private bool _disposed;

    [Parameter]
    public TextModel? Model { get; set; }

    [Parameter]
    public EventCallback OnEditorInit { get; set; }

    private StandaloneEditorConstructionOptions EditorConstructionOptions(StandaloneCodeEditor editor)
    {
        return new StandaloneEditorConstructionOptions
        {
            AutomaticLayout = true,
            Language = "plaintext",
            Theme = "vs-dark",
            Minimap = new EditorMinimapOptions { Enabled = false }
        };
    }

    private async Task EditorOnDidInit()
    {
        _isEditorInitialized = true;

        // Prefer the latest incoming parameter value; fallback to any pending value captured
        // before the editor was initialized.
        var modelToApply = Model ?? _pendingModel;
        _pendingModel = null;

        if (modelToApply != null)
        {
            await ApplyModelIfNeeded(modelToApply);
        }

        if (!_disposed)
        {
            await OnEditorInit.InvokeAsync();
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        if (_disposed)
            return;

        if (Model == null)
            return;

        // If the editor JS instance isn't created yet, defer model application until OnDidInit.
        if (!_isEditorInitialized)
        {
            _pendingModel = Model;
            return;
        }

        await ApplyModelIfNeeded(Model);
    }

    public async Task Layout()
    {
        if (_disposed)
            return;

        if (_editor != null && _isEditorInitialized)
        {
            await _editor.Layout();
        }
    }

    private async Task ApplyModelIfNeeded(TextModel model)
    {
        if (_disposed || _editor == null || !_isEditorInitialized)
            return;

        // Avoid calling GetModel() here: it's a JS interop call and can race during init.
        var modelUri = model.Uri;
        if (_currentModelUri == modelUri)
            return;

        _currentModelUri = modelUri;
        await _editor.SetModel(model);
    }

    public void Dispose()
    {
        _disposed = true;
    }
}
